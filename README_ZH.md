# 足球分析專案

## 簡介
本專案旨在使用 YOLO（最佳的 AI 物體偵測模型之一）來偵測和追蹤影片中的球員、裁判和足球。我們還會訓練模型以提高其性能。此外，我們將使用 K-means 進行像素分割和聚類，根據球衣顏色將球員分配到各隊。有了這些資訊，我們可以測量比賽中每支球隊的控球百分比。我們還將使用光流法來測量幀之間的相機移動，從而準確測量球員的移動。此外，我們將實施透視轉換來表示場景的深度和透視，使我們能夠以米為單位而不是像素來測量球員的移動。最後，我們將計算球員的速度和所覆蓋的距離。

**新功能：現在包含基於 Qt 的圖形使用者介面，讓影片分析更加簡單！**

![截圖](output_videos/screenshot.png)

## 目錄
- [專案功能](#專案功能)
- [Qt 圖形介面應用程式](#qt-圖形介面應用程式)
- [系統架構](#系統架構)
- [運作原理](#運作原理)
- [使用的模組](#使用的模組)
- [處理流程](#處理流程)
- [系統需求](#系統需求)
- [安裝說明](#安裝說明)
- [使用方法](#使用方法)
- [輸出結果](#輸出結果)

## 專案功能

這個足球分析系統可以處理足球比賽的影片素材，提取有關球員移動、球隊表現和比賽動態的有意義的見解。

### 核心功能

1. **多物體偵測與追蹤**
   - 同時偵測和追蹤多個球員、裁判和足球
   - 為每個追蹤的物體維護唯一的 ID
   - 處理部分遮擋和重新識別

2. **球隊識別**
   - 根據球衣顏色自動識別兩支球隊
   - 使用無監督學習（K-means）進行顏色聚類
   - 使用彩色橢圓視覺化表示球隊分配

3. **控球追蹤**
   - 即時控球分配
   - 基於距離的控球計算
   - 球隊控球統計和百分比

4. **移動分析**
   - 相機移動偵測和補償
   - 真實世界距離計算（以米為單位）
   - 球員速度計算（以公里/小時為單位）
   - 每個球員的累積距離追蹤

5. **視覺化分析**
   - 使用彩色橢圓進行球員追蹤
   - 球隊識別顏色
   - 控球指示器（三角形）
   - 螢幕統計資料顯示
   - 相機移動指示器

## Qt 圖形介面應用程式

本專案現在包含一個全面的基於 Qt 的圖形使用者介面（`qt_main.py`），使影片分析變得簡單和互動。

### 圖形介面功能：
- **互動式檔案選擇**：使用檔案選擇器瀏覽和選擇輸入影片
- **即時進度追蹤**：分析期間的視覺進度條和狀態更新
- **影片播放器**：內建影片播放器可預覽輸入和播放分析輸出
- **可配置設定**：
  - 切換快取使用以加快重新分析速度
  - 選擇不同的 YOLO 模型
  - 選擇自訂輸出路徑
- **分析日誌**：顯示分析步驟和進度的即時日誌
- **播放控制**：播放/暫停和逐幀導航結果
- **現代化介面**：使用 PyQt5 建構的清晰、直觀的介面

### 啟動圖形介面：
```bash
python qt_main.py
```

### 圖形介面工作流程：
1. 點擊「瀏覽...」選擇輸入影片
2. （選擇性）配置設定，如快取使用和模型選擇
3. 點擊「開始分析」開始處理
4. 透過進度條和日誌即時監控進度
5. 完成後，分析的影片會自動載入到播放器中
6. 使用播放控制查看分析結果

圖形介面在後台執行緒中執行分析，在處理期間保持介面的回應性。

📖 **[閱讀完整的 Qt GUI 指南（中文）](QT_GUI_GUIDE_ZH.md)** 以獲取詳細說明、疑難排解和提示。

## 系統架構

```
輸入影片
    |
    v
[影片讀取器] --> 影格
    |
    v
[YOLO 偵測] --> 原始偵測
    |
    v
[ByteTrack] --> 追蹤的物體（球員、裁判、足球）
    |
    +---> [球隊分配器] --> 球隊分類
    |
    +---> [相機移動估計器] --> 相機調整
    |
    +---> [視角轉換器] --> 真實世界座標
    |
    +---> [控球分配器] --> 控球資料
    |
    +---> [速度與距離估計器] --> 性能指標
    |
    v
[視覺化引擎] --> 標註的影格
    |
    v
[影片寫入器] --> 輸出影片
```

## 運作原理

### 1. 影片輸入與物體偵測
- 系統從輸入影片檔案讀取影片影格
- 使用訓練過的 YOLO v5 模型在每個影格中偵測球員、裁判和足球
- 批次處理影格以提高效率

### 2. 物體追蹤
- 實現 ByteTrack 演算法以維護影格間一致的追蹤 ID
- 在整個影片中追蹤球員和裁判
- 處理遮擋和暫時消失
- 插值足球位置以處理偵測間隙

### 3. 球隊分配
- 分析每個球員邊界框的上半部分（球衣區域）
- 使用 K-means 聚類對像素顏色進行聚類以識別球隊球衣
- 根據球衣顏色將球員分配到球隊 1 或球隊 2
- 在整個比賽中保持一致的球隊分配

### 4. 相機移動補償
- 使用光流（Lucas-Kanade 方法）偵測相機移動
- 追蹤連續影格之間的特徵點
- 調整球員位置以補償相機平移和移動
- 確保準確測量實際球員移動

### 5. 透視轉換
- 將 2D 像素座標轉換為真實世界測量
- 使用透視轉換將球場位置映射到米
- 啟用準確的距離和速度計算
- 考慮相機角度和場地透視

### 6. 控球分析
- 計算每個球員與足球之間的距離
- 將控球分配給閾值內的最近球員
- 隨時間追蹤控球
- 計算每支球隊的控球百分比

### 7. 速度與距離計算
- 測量每個球員以米為單位行進的距離
- 計算球員速度（公里/小時）
- 在整個影片中即時更新測量
- 顯示每個追蹤球員的速度和距離

### 8. 視覺化與輸出
- 用球隊顏色在球員周圍繪製橢圓
- 顯示球員 ID 和追蹤資訊
- 顯示控球指示器
- 顯示相機移動、速度、距離和球隊統計資料
- 生成標註的輸出影片

## 使用的模組
本專案中使用了以下模組：
- **YOLO v5**：用於識別球員、裁判和足球的最先進物體偵測模型
- **ByteTrack**：用於維護一致 ID 的多物體追蹤演算法
- **K-means 聚類**：用於球隊顏色識別的無監督學習
- **光流（Lucas-Kanade）**：影格之間的相機移動偵測
- **透視轉換**：將像素座標轉換為真實世界測量
- **OpenCV**：電腦視覺操作和影片處理

## 處理流程

### 逐步過程：

1. **影片載入** (`utils/video_utils.py`)
   - 逐幀讀取影片檔案
   - 將影格儲存在記憶體中進行處理

2. **物體偵測** (`trackers/tracker.py`)
   - 使用訓練權重初始化 YOLO 模型
   - 批次偵測物體（batch_size=20）
   - 將偵測轉換為 supervision 格式

3. **物體追蹤** (`trackers/tracker.py`)
   - 應用 ByteTrack 演算法
   - 分配和維護追蹤 ID
   - 插值缺失的足球位置

4. **位置計算** (`utils/bbox_utils.py`)
   - 計算足球的中心點
   - 計算球員的腳部位置
   - 在追蹤中儲存位置資料

5. **相機移動分析** (`camera_movement_estimator/`)
   - 從第一幀提取特徵點
   - 使用 Lucas-Kanade 光流追蹤特徵
   - 計算相機移動向量
   - 調整所有物體位置

6. **透視轉換** (`view_transformer/`)
   - 定義球場像素頂點和真實世界尺寸
   - 應用透視轉換矩陣
   - 將調整後的位置轉換為米

7. **球隊分配** (`team_assigner/`)
   - 從第一幀提取球衣顏色
   - 使用 K-means 將顏色聚類為兩支球隊
   - 為所有球員分配球隊 ID
   - 在整個影片中維護球隊分配

8. **控球** (`player_ball_assigner/`)
   - 計算從每個球員到足球的距離
   - 將球分配給閾值內的最近球員（70 像素）
   - 隨時間追蹤控球變化

9. **速度與距離計算** (`speed_and_distance_estimator/`)
   - 測量影格窗口之間的距離（5 幀）
   - 根據距離和時間計算速度
   - 累積總行進距離
   - 轉換為公里/小時和米

10. **視覺化** (`trackers/tracker.py`)
    - 在球員周圍繪製橢圓（按球隊顏色編碼）
    - 為足球和控球指示器繪製三角形
    - 顯示球隊統計資料和控球
    - 顯示相機移動資料
    - 顯示每個球員的速度和距離

11. **輸出生成** (`utils/video_utils.py`)
    - 將標註的影格寫入輸出影片
    - 儲存為帶有 XVID 編解碼器的 AVI 格式

## 訓練的模型
- [訓練的 Yolo v5](https://drive.google.com/file/d/1DC2kCygbBWUKheQ_9cFziCsYVSRw6axK/view?usp=sharing)

## 範例影片
- [範例輸入影片](https://drive.google.com/file/d/1t6agoqggZKx6thamUuPAIdN_1zR9v9S_/view?usp=sharing)

## 系統需求
要執行此專案，您需要安裝以下需求：
- Python 3.x
- ultralytics（YOLO 實現）
- supervision（追蹤工具）
- OpenCV (cv2) - 電腦視覺操作
- NumPy - 數值計算
- Matplotlib - 視覺化
- Pandas - 資料處理
- scikit-learn (sklearn) - K-means 聚類
- PyQt5（GUI 框架）- **Qt GUI 應用程式所需**

## 安裝說明

```bash
# 複製儲存庫
git clone https://github.com/vesss1/foot.git
cd foot

# 安裝所需套件
pip install -r requirements.txt

# 或手動安裝：
pip install ultralytics supervision opencv-python numpy matplotlib pandas scikit-learn PyQt5

# 下載訓練的模型
# 將模型檔案放在 models/ 目錄中，命名為 models/best.pt

# 下載範例影片（選擇性）
# 將輸入影片放在 input_videos/ 目錄中
```

### 在 Qt Creator（IDE）中開啟

如果您想使用 Qt Creator IDE 查看和編輯專案：

1. 開啟 Qt Creator
2. 點擊「檔案」→「開啟檔案或專案...」
3. 導航到專案目錄並選擇 `foot.pro`
4. Qt Creator 將載入專案結構，所有 Python 檔案都已組織好

**注意**：這是一個使用 PyQt5 的 Python 專案。Qt Creator 提供了一個 IDE 環境來查看和編輯程式碼，但您仍然會使用標準 Python 解譯器來執行 Python 腳本。

📖 **[閱讀完整的 Qt Creator 整合指南](QT_CREATOR_SETUP_ZH.md)** 以獲取詳細的安裝和配置說明。

## 使用方法

### 選項 1：Qt 圖形介面應用程式（推薦）

```bash
# 啟動圖形介面
python qt_main.py
```

**圖形介面使用方法：**
1. 點擊「瀏覽...」選擇您的輸入影片檔案
2. （選擇性）調整設定：
   - 啟用/停用快取以加快重新執行速度
   - 選擇不同的 YOLO 模型
   - 變更輸出檔案位置
3. 點擊「開始分析」開始處理
4. 透過進度條和日誌監控即時進度
5. 完成後，使用內建播放器查看結果
6. 使用播放控制進行播放/暫停和導航影格

**圖形介面的好處：**
- 無需編輯程式碼
- 處理期間的視覺回饋
- 內建結果影片播放器
- 簡單的配置管理
- 適合初學者的介面

### 選項 2：命令列腳本

```bash
# 執行分析腳本
python main.py
```

腳本將：
1. 從 `input_videos/08fd33_4.mp4` 讀取輸入影片
2. 透過管道處理所有影格
3. 在 `output_videos/output_video.avi` 生成標註的輸出影片

**注意**：首次執行可能需要更長時間。後續執行使用快取的 stub 檔案以加快處理速度。

### main.py 中的配置選項：
- `read_from_stub=True`：使用快取的追蹤/相機資料
- `stub_path`：快取檔案的路徑
- 影片輸入路徑
- 輸出影片路徑

## 輸出結果

生成的影片包括：
- 彩色編碼的球員追蹤（帶有球隊顏色的橢圓）
- 球衣上的球員 ID
- 足球追蹤（綠色三角形）
- 控球指示器（球員上方的紅色三角形）
- 球隊控球百分比
- 相機移動 X/Y 座標
- 個別球員速度（公里/小時）
- 個別球員行進距離（米）

## 專案結構

```
foot/
├── main.py                          # 命令列執行腳本
├── qt_main.py                       # Qt GUI 應用程式（新）
├── requirements.txt                 # Python 依賴項（新）
├── yolo_inference.py                # YOLO 推理工具
├── models/                          # 訓練的模型檔案
│   └── best.pt                      # YOLO v5 訓練權重
├── input_videos/                    # 輸入影片檔案
├── output_videos/                   # 生成的輸出影片
├── stubs/                           # 快取的處理資料
│   ├── track_stubs.pkl             # 快取的追蹤資料
│   └── camera_movement_stub.pkl    # 快取的相機移動
├── trackers/                        # 物體偵測和追蹤
│   ├── __init__.py
│   └── tracker.py
├── team_assigner/                   # 球隊識別
│   ├── __init__.py
│   └── team_assigner.py
├── player_ball_assigner/            # 控球邏輯
│   ├── __init__.py
│   └── player_ball_assigner.py
├── camera_movement_estimator/       # 相機移動偵測
│   ├── __init__.py
│   └── camera_movement_estimator.py
├── view_transformer/                # 透視轉換
│   ├── __init__.py
│   └── view_transformer.py
├── speed_and_distance_estimator/    # 性能指標
│   ├── __init__.py
│   └── speed_and_distance_estimator.py
└── utils/                           # 輔助函數
    ├── __init__.py
    ├── bbox_utils.py               # 邊界框工具
    └── video_utils.py              # 影片 I/O 工具
```

## 技術細節

### 性能優化：
- 批次處理影格以進行 YOLO 偵測
- Stub 檔案快取追蹤和相機移動資料
- 高效的 numpy 操作進行轉換
- 速度/距離計算的影格窗口方法

### 準確性考慮：
- 足球位置插值處理偵測間隙
- 相機移動補償確保準確測量
- 透視轉換提供真實世界座標
- 控球分配的多重距離檢查

### 限制：
- 需要透視轉換的校準點
- 性能取決於影片品質和相機角度
- 球衣顏色偵測可能在類似球隊顏色時失敗
- 假設相對穩定的相機移動

## 未來增強功能

潛在改進：
- 即時處理能力
- 支援多相機角度
- 進階球員統計（熱圖、傳球偵測）
- 自動相機校準
- 基於深度學習的球隊分配
- 球員識別和球衣號碼識別
- 戰術分析和陣型偵測

## 常見問題

**問：這個專案是做什麼用的？**
答：這是一個足球影片分析系統，可以自動偵測和追蹤球員、足球和裁判，計算球員速度和距離，識別球隊，並分析控球情況。

**問：我需要什麼硬體？**
答：需要一台裝有 Python 3.x 的電腦。建議使用支援 GPU 的系統以加快處理速度，但也可以使用 CPU。

**問：我可以分析自己的足球影片嗎？**
答：可以！只需將您的影片放在 input_videos/ 目錄中，並使用圖形介面或修改 main.py 中的路徑。

**問：處理需要多長時間？**
答：這取決於影片長度和您的硬體。首次執行較慢，但後續執行使用快取會更快。

**問：我需要訓練模型嗎？**
答：不需要。專案提供了預訓練的 YOLO v5 模型。只需從提供的連結下載即可。

## 支援

如有問題或疑問：
1. 查看此指南以獲取疑難排解資訊
2. 查閱主要 README.md 以獲取技術細節
3. 確保正確安裝所有依賴項
4. 驗證影片檔案是否為支援的格式

## 授權

請參閱 LICENSE 檔案以獲取授權詳細資訊。

---

**享受足球影片分析！** ⚽
